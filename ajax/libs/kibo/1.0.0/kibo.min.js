var Kibo=function(e){this.element=e||window.document,this.initialize()};Kibo.KEY_NAMES_BY_CODE={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"caps_lock",27:"esc",32:"space",33:"page_up",34:"page_down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"num_lock"},Kibo.KEY_CODES_BY_NAME={},function(){for(var e in Kibo.KEY_NAMES_BY_CODE)Object.prototype.hasOwnProperty.call(Kibo.KEY_NAMES_BY_CODE,e)&&(Kibo.KEY_CODES_BY_NAME[Kibo.KEY_NAMES_BY_CODE[e]]=+e)}(),Kibo.MODIFIERS=["shift","ctrl","alt"],Kibo.WILDCARD_TYPES=["arrow","number","letter","f"],Kibo.WILDCARDS={arrow:[37,38,39,40],number:[48,49,50,51,52,53,54,55,56,57],letter:[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90],f:[112,113,114,115,116,117,118,119,120,121,122,123]},Kibo.assert=function(e,t){t=t||{},t.name=t.name||"Exception raised",t.message=t.message||"an error has occurred.";try{if(!e)throw t}catch(i){"undefined"!=typeof console&&console.log?console.log(i.name+": "+i.message):window.alert(i.name+": "+i.message)}},Kibo.registerEvent=function(){return document.addEventListener?function(e,t,i){e.addEventListener(t,i,!1)}:document.attachEvent?function(e,t,i){e.attachEvent("on"+t,i)}:void 0}(),Kibo.unregisterEvent=function(){return document.removeEventListener?function(e,t,i){e.removeEventListener(t,i,!1)}:document.detachEvent?function(e,t,i){e.detachEvent("on"+t,i)}:void 0}(),Kibo.isArray=function(e){return!(!e||!e.splice)},Kibo.isString=function(e){return"string"==typeof e},Kibo.arrayIncludes=function(){return Array.prototype.indexOf?function(e,t){return-1!==e.indexOf(t)}:function(e,t){for(var i=0;e.length>i;i++)if(e[i]===t)return!0;return!1}}(),Kibo.trimString=function(e){return e.replace(/^\s+|\s+$/g,"")},Kibo.neatString=function(e){return Kibo.trimString(e).replace(/\s+/g," ")},Kibo.capitalize=function(e){return e.toLowerCase().replace(/^./,function(e){return e.toUpperCase()})},Kibo.isModifier=function(e){return Kibo.arrayIncludes(Kibo.MODIFIERS,e)},Kibo.prototype.initialize=function(){var e,t=this;for(this.lastKeyCode=-1,this.lastModifiers={},e=0;Kibo.MODIFIERS.length>e;e++)this.lastModifiers[Kibo.MODIFIERS[e]]=!1;for(this.keysDown={any:[]},this.keysUp={any:[]},e=0;Kibo.WILDCARD_TYPES.length>e;e++)this.keysDown["any "+Kibo.WILDCARD_TYPES[e]]=[],this.keysUp["any "+Kibo.WILDCARD_TYPES[e]]=[];this.downHandler=this.handler("down"),this.upHandler=this.handler("up"),Kibo.registerEvent(this.element,"keydown",this.downHandler),Kibo.registerEvent(this.element,"keyup",this.upHandler),Kibo.registerEvent(window,"unload",function i(){Kibo.unregisterEvent(t.element,"keydown",t.downHandler),Kibo.unregisterEvent(t.element,"keyup",t.upHandler),Kibo.unregisterEvent(window,"unload",i)})},Kibo.prototype.matchingKeys=function(e){var t,i,n,o=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&(i=Kibo.trimString(r).split(" "),i.length&&"any"!==i[0])){for(n=!0,t=0;i.length>t;t++)n=n&&(Kibo.isModifier(i[t])?this.lastKey(i[t]):this.lastKey()===i[t]);n&&o.push(r)}return o},Kibo.prototype.handler=function(e){var t=this;return function(i){var n,o,r,s;for(i=i||window.event,t.lastKeyCode=i.keyCode,n=0;Kibo.MODIFIERS.length>n;n++)t.lastModifiers[Kibo.MODIFIERS[n]]=i[Kibo.MODIFIERS[n]+"Key"];for(Kibo.arrayIncludes(Kibo.MODIFIERS,Kibo.keyName(t.lastKeyCode))&&(t.lastModifiers[Kibo.keyName(t.lastKeyCode)]=!0),s=t["keys"+Kibo.capitalize(e)],r=t.matchingKeys(s),n=0;s.any.length>n;n++)s.any[n](i)===!1&&i.preventDefault&&i.preventDefault();for(n=0;Kibo.WILDCARD_TYPES.length>n;n++)if(Kibo.arrayIncludes(Kibo.WILDCARDS[Kibo.WILDCARD_TYPES[n]],t.lastKeyCode))for(o=0;s["any "+Kibo.WILDCARD_TYPES[n]].length>o;o++)s["any "+Kibo.WILDCARD_TYPES[n]][o](i)===!1&&i.preventDefault&&i.preventDefault();for(n=0;r.length>n;n++)for(o=0;s[r[n]].length>o;o++)s[r[n]][o](i)===!1&&i.preventDefault&&i.preventDefault()}},Kibo.prototype.registerKeys=function(e,t,i){var n,o=this["keys"+Kibo.capitalize(e)];for(Kibo.isArray(t)||(t=[t]),n=0;t.length>n;n++)Kibo.assert(Kibo.isString(t[n]),{name:"Type error",message:"expected string or array of strings."}),t[n]=Kibo.neatString(t[n]),Kibo.isArray(o[t[n]])?o[t[n]].push(i):o[t[n]]=[i];return this},Kibo.prototype.unregisterKeys=function(e,t,i){var n,o,r=this["keys"+Kibo.capitalize(e)];for(Kibo.isArray(t)||(t=[t]),n=0;t.length>n;n++)if(Kibo.assert(Kibo.isString(t[n]),{name:"Type error",message:"expected string or array of strings."}),t[n]=Kibo.neatString(t[n]),null===i)delete r[t[n]];else if(Kibo.isArray(r[t[n]]))for(o=0;r[t[n]].length>o;o++)if(r[t[n]][o]+""==i+""){r[t[n]].splice(o,1);break}return this},Kibo.prototype.delegate=function(e,t,i){return null!==i?this.registerKeys(e,t,i):this.unregisterKeys(e,t,i)},Kibo.prototype.down=function(e,t){return this.delegate("down",e,t)},Kibo.prototype.up=function(e,t){return this.delegate("up",e,t)},Kibo.keyName=function(e){return Kibo.KEY_NAMES_BY_CODE[e+""]},Kibo.keyCode=function(e){return+Kibo.KEY_CODES_BY_NAME[e]},Kibo.prototype.lastKey=function(e){return e?(Kibo.assert(Kibo.arrayIncludes(Kibo.MODIFIERS,e),{name:"Modifier error",message:"invalid modifier "+e+" (valid modifiers are: "+Kibo.MODIFIERS.join(", ")+")."}),this.lastModifiers[e]):Kibo.keyName(this.lastKeyCode)};